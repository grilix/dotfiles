#!/usr/bin/env bash

user-name() {
  getent passwd $UID | \
    awk -F: '{print $5}' | \
    awk -F, '{print $1}'
}

get-key() { EMAIL="$1";
  gpg --list-options show-only-fpr-mbox --list-secret-keys 2>/dev/null |
    grep "$EMAIL" |
    awk '{print $1}'
}

check-err() {
  if [ $? != 0 ]; then
    # El resultado de esto es medio bajón, lo mejor
    # sería tener un log, pero por ahora es suficiente."
    echo "$1" >&2
    exit -2
  fi
}

git config --local -l >/dev/null 2>&1
check-err "Esta herramienta debe ser usada desde un repositorio git."

EMAIL="$1"
# Esto sube la clave pública a un servidor por conveniencia, cámbialo
# si quieres evitarlo y la clave pública se escribirá en la salida estándar.
UPLOAD_PKEY="y"

if [ -z "$EMAIL" ]; then
  echo "Provee una dirección de email." >&2
  echo "Por ejemplo: " >&2
  echo "  git-email $USER@$HOSTNAME" >&2
  exit -1
fi

if [ -z "$NAME" ]; then
  NAME=$(user-name)
  if [ -z "$NAME" ]; then
    echo "Tu cuenta no tiene tu nombre, $USER." >&2
    echo "" >&2
    echo "Puedes cambiarlo con:" >&2
    echo "  sudo chfn -f "Mi Nombre" \$USER" >&2
  fi
fi

FPR=$(get-key "$EMAIL" 2>/dev/null)

if [ -z "$FPR" ]; then
  echo "No se encontraron claves para la dirección de email $EMAIL, crearemos una nueva."

  RES=$(gpg --batch --passphrase '' \
      --quick-generate-key "$NAME <$EMAIL>" rsa4096 cert 0 2>&1)
  check-err "$RES"
  FPR=$(get-key "$EMAIL")
  check-err "No se pudo obtener la clave para $EMAIL"

  RES=$(gpg --batch --passphrase '' \
      --quick-add-key $FPR rsa4096 sign 2m 2>&1)
  check-err "$RES"
  RES=$(gpg --batch --passphrase '' \
      --quick-add-key $FPR rsa4096 encrypt 2m 2>&1)
  check-err "$RES"

  if [ "$UPLOAD_PKEY" == "y" ]; then
    echo ""
    echo -n "Exportando clave pública: "
    gpg --export -a "$EMAIL" | curl -F 'sprunge=<-' 'http://sprunge.us/'
  else
    gpg --export -a "$EMAIL"
  fi

  echo ""
  cat <<EOF
Probablemente quieras pegarla en sitios como github o gitlab:

  Github: https://github.com/settings/keys"
  Gitlab: https://gitlab.com/-/profile/gpg_keys"

EOF
fi

git config --local user.signingkey $FPR
git config --local user.email "$EMAIL"
